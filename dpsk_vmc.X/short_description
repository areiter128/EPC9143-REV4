P33C_CE201: Closed Loop Voltage Mode Control with Adaptive Gain Modulation
==========================================================================

This code example establishes a closed loop control system using voltage mode control
of the buck converter of the Digital Power Starter Kit 3 (Part-No. DM330017-3).

The control system consists of three major blocks:

    - Buck Converter State Machine (startup and runtime control, fault detection and auto-recovery)
    - Cycle-by-Cycle Voltage Control Loop
    - Adaptive Gain Modulation extension to main Voltage Mode Control Loop

1) Buck Converter State Machine

The state machine goes through the following steps in chronological order:

a) Initialization

In this step the control loop parameters are reset to their defaults, PWM outputs are turned off
but the PWM is still running, continuously triggering the ADC to keep sampling input and output 
voltage as well as board temperature.

b) Reset
This is the 'fall-back' state from which the buck converter will be restarted once it has been
started successfully and has been shut down due to a fault condition (e.g. input under/over 
voltage or over temperature condition)

c) Standby
After RESET, the state machine waits for all fault flags to be cleared and the enable and GO
bits to be set.

d) Power-On Delay (POD)
Once the buck converter has been cleared the state machine will execute the startup procedure
starting with the Power On Delay. This is just a simple delay during which the converter will  
remain inactive but the fault handler will observe the values generated by the ADC for occurring 
fault conditions.

e) Launch Voltage Ramp
After the Power-On delay has expired, input and output voltage will be measured. In case the 
converter output is pre-biased (voltage = non-zero), the power controller will be 'pre-charged'
with an artificial control history and PWM output to softly ramp up the output voltage from its
most recent level. 

f) Voltage Ramp-Up
Now the digital feedback loop and PWM are enabled and the closed loop system reference value
is incremented with every execution of the state machine (100usec interval). The control loop
has been adjusted to operate with a cross-over frequency of >10 kHz matching the maximum 
perturbance frequency allowed to keep the control system stable.  

g) Power Good Delay
After the reference voltage has been increased to the pre-defined nominal level, the state 
machine switches over into the Power Good Delay period. This is another, simple delay where
the control loop is in steady state waiting for the delay period to expire.

h) Online
After the Power Good Delay has expired, the converter drops into nominal operation. In this
condition it continuously observes the reference value for changes. Should any other part 
of the firmware change the controller reference, the state machine will softly tune into the
new level instead of hard-switching the reference. 

i) Suspend
If the power controller is shut down and reset by external commands (e.g. fault handler 
detecting a fault condition or through user-interaction), the state machine is switching
into the SUSPEND state, which disables the PWM outputs and control loop execution, clears 
the control histories and resets the state machine back to RESET


2) Cycle-by-Cycle Voltage Control Loop

This firmware uses a digital type III controller to close the feedback loop in voltage mode 
control. This digital loop reads the most recent ADC sample of the output voltage and processes
its value through a digital type III (3P3Z) compensation filter. The numeric output is checked 
and, when necessary, clamped to user-defined minimum/maximum thresholds before being written
to the PWM duty cycle register.

This control loop can be turned on/off by using the ENABLED bit in the STATUS word or the 
cNPNZ_t controller data structure.


3) Adaptive Gain Modulation extension to main Voltage Mode Control Loop

The Cycle-by-Cycle Voltage Mode Controller has been extended to incorporate a specific form 
of feed-forward control. This feed-forward implementation continuously measures the 
volt-seconds across the buck converter main inductor to detect and determine changes in 
fundamental DC gain of the plant. Any deviation in fundamental DC plant gain is then compensated 
by increasing/decreasing the general loop gain by modulating its integrator gain on a cycle-by-cycle 
basis.




_________________________________________________
(c) 2020, Microchip Technology Inc.

